
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="A minimal HTTP client for Python.">
      
      
      
        <link rel="canonical" href="https://www.encode.io/httpcore/network-backends/">
      
      
        <link rel="prev" href="../async/">
      
      
        <link rel="next" href="../extensions/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.0, mkdocs-material-9.5.27">
    
    
      
        <title>Network Backends - HTTPCore</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.6543a935.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#network-backends" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="HTTPCore" class="md-header__button md-logo" aria-label="HTTPCore" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            HTTPCore
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Network Backends
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/encode/httpcore/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    encode/httpcore
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="HTTPCore" class="md-nav__button md-logo" aria-label="HTTPCore" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    HTTPCore
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/encode/httpcore/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    encode/httpcore
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Introduction
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../quickstart/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Quickstart
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../connection-pools/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Connection Pools
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../proxies/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Proxies
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../http2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    HTTP/2
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../async/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Async Support
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Network Backends
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Network Backends
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#working-with-network-backends" class="md-nav__link">
    <span class="md-ellipsis">
      Working with network backends
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Working with network backends">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-default-network-backend" class="md-nav__link">
    <span class="md-ellipsis">
      The default network backend
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#async-network-backends" class="md-nav__link">
    <span class="md-ellipsis">
      Async network backends
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mock-network-backends" class="md-nav__link">
    <span class="md-ellipsis">
      Mock network backends
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#custom-network-backends" class="md-nav__link">
    <span class="md-ellipsis">
      Custom network backends
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#reference" class="md-nav__link">
    <span class="md-ellipsis">
      Reference
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Reference">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#networking-backends" class="md-nav__link">
    <span class="md-ellipsis">
      Networking Backends
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mock-backends" class="md-nav__link">
    <span class="md-ellipsis">
      Mock Backends
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#base-interface" class="md-nav__link">
    <span class="md-ellipsis">
      Base Interface
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../extensions/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Extensions
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../logging/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Logging
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../exceptions/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Exceptions
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#working-with-network-backends" class="md-nav__link">
    <span class="md-ellipsis">
      Working with network backends
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Working with network backends">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-default-network-backend" class="md-nav__link">
    <span class="md-ellipsis">
      The default network backend
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#async-network-backends" class="md-nav__link">
    <span class="md-ellipsis">
      Async network backends
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mock-network-backends" class="md-nav__link">
    <span class="md-ellipsis">
      Mock network backends
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#custom-network-backends" class="md-nav__link">
    <span class="md-ellipsis">
      Custom network backends
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#reference" class="md-nav__link">
    <span class="md-ellipsis">
      Reference
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Reference">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#networking-backends" class="md-nav__link">
    <span class="md-ellipsis">
      Networking Backends
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mock-backends" class="md-nav__link">
    <span class="md-ellipsis">
      Mock Backends
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#base-interface" class="md-nav__link">
    <span class="md-ellipsis">
      Base Interface
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="network-backends">Network Backends</h1>
<p>The API layer at which <code>httpcore</code> interacts with the network is described as the network backend. Various backend implementations are provided, allowing <code>httpcore</code> to handle networking in different runtime contexts.</p>
<h2 id="working-with-network-backends">Working with network backends</h2>
<h3 id="the-default-network-backend">The default network backend</h3>
<p>Typically you won't need to specify a network backend, as a default will automatically be selected. However, understanding how the network backends fit in may be useful if you want to better understand the underlying architecture. Let's start by seeing how we can explicitly select the network backend.</p>
<p>First we're making a standard HTTP request, using a connection pool:</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">httpcore</span>

<span class="k">with</span> <span class="n">httpcore</span><span class="o">.</span><span class="n">ConnectionPool</span><span class="p">()</span> <span class="k">as</span> <span class="n">http</span><span class="p">:</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">http</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;https://www.example.com&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</code></pre></div>

<p>We can also have the same behavior, but be explicit with our selection of the network backend:</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">httpcore</span>

<span class="n">network_backend</span> <span class="o">=</span> <span class="n">httpcore</span><span class="o">.</span><span class="n">SyncBackend</span><span class="p">()</span>
<span class="k">with</span> <span class="n">httpcore</span><span class="o">.</span><span class="n">ConnectionPool</span><span class="p">(</span><span class="n">network_backend</span><span class="o">=</span><span class="n">network_backend</span><span class="p">)</span> <span class="k">as</span> <span class="n">http</span><span class="p">:</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">http</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;https://www.example.com&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</code></pre></div>

<p>The <code>httpcore.SyncBackend()</code> implementation handles the opening of TCP connections, and operations on the socket stream, such as reading, writing, and closing the connection.</p>
<p>We can get a better understanding of this by using a network backend to send a basic HTTP/1.1 request directly:</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">httpcore</span>

<span class="c1"># Create an SSL context using &#39;certifi&#39; for the certificates.</span>
<span class="n">ssl_context</span> <span class="o">=</span> <span class="n">httpcore</span><span class="o">.</span><span class="n">default_ssl_context</span><span class="p">()</span>

<span class="c1"># A basic HTTP/1.1 request as a plain bytestring.</span>
<span class="n">request</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\r\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
    <span class="sa">b</span><span class="s1">&#39;GET / HTTP/1.1&#39;</span><span class="p">,</span>
    <span class="sa">b</span><span class="s1">&#39;Host: www.example.com&#39;</span><span class="p">,</span>
    <span class="sa">b</span><span class="s1">&#39;Accept: */*&#39;</span><span class="p">,</span>
    <span class="sa">b</span><span class="s1">&#39;Connection: close&#39;</span><span class="p">,</span>
    <span class="sa">b</span><span class="s1">&#39;&#39;</span>
<span class="p">])</span>

<span class="c1"># Open a TCP stream and upgrade it to SSL.</span>
<span class="n">network_backend</span> <span class="o">=</span> <span class="n">httpcore</span><span class="o">.</span><span class="n">SyncBackend</span><span class="p">()</span>
<span class="n">network_stream</span> <span class="o">=</span> <span class="n">network_backend</span><span class="o">.</span><span class="n">connect_tcp</span><span class="p">(</span><span class="s2">&quot;www.example.com&quot;</span><span class="p">,</span> <span class="mi">443</span><span class="p">)</span>
<span class="n">network_stream</span> <span class="o">=</span> <span class="n">network_stream</span><span class="o">.</span><span class="n">start_tls</span><span class="p">(</span><span class="n">ssl_context</span><span class="p">,</span> <span class="n">server_hostname</span><span class="o">=</span><span class="s2">&quot;www.example.com&quot;</span><span class="p">)</span>

<span class="c1"># Send the HTTP request.</span>
<span class="n">network_stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

<span class="c1"># Read the HTTP response.</span>
<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">network_stream</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">max_bytes</span><span class="o">=</span><span class="mi">4096</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">response</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="k">break</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>

<span class="c1"># The output should look something like this:</span>
<span class="c1">#</span>
<span class="c1"># b&#39;HTTP/1.1 200 OK\r\nAge: 600005\r\n [...] Content-Length: 1256\r\nConnection: close\r\n\r\n&#39;</span>
<span class="c1"># b&#39;&lt;!doctype html&gt;\n&lt;html&gt;\n&lt;head&gt;\n    &lt;title&gt;Example Domain&lt;/title&gt; [...] &lt;/html&gt;\n&#39;</span>
</code></pre></div>

<h3 id="async-network-backends">Async network backends</h3>
<p>If we're working with an <code>async</code> codebase, then we need to select a different backend.</p>
<p>The <code>httpcore.AnyIOBackend</code> is suitable for usage if you're running under <code>asyncio</code>. This is a networking backend implemented using <a href="https://anyio.readthedocs.io/en/3.x/">the <code>anyio</code> package</a>.</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">httpcore</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>

<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
    <span class="n">network_backend</span> <span class="o">=</span> <span class="n">httpcore</span><span class="o">.</span><span class="n">AnyIOBackend</span><span class="p">()</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">httpcore</span><span class="o">.</span><span class="n">AsyncConnectionPool</span><span class="p">(</span><span class="n">network_backend</span><span class="o">=</span><span class="n">network_backend</span><span class="p">)</span> <span class="k">as</span> <span class="n">http</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">http</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;https://www.example.com&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>

<span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</code></pre></div>

<p>The <code>AnyIOBackend</code> will work when running under either <code>asyncio</code> or <code>trio</code>. However, if you're working with async using the <a href="https://trio.readthedocs.io/en/stable/"><code>trio</code> framework</a>, then we recommend using the <code>httpcore.TrioBackend</code>.</p>
<p>This will give you the same kind of networking behavior you'd have using <code>AnyIOBackend</code>, but there will be a little less indirection so it will be marginally more efficient and will present cleaner tracebacks in error cases.</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">httpcore</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">trio</span>

<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
    <span class="n">network_backend</span> <span class="o">=</span> <span class="n">httpcore</span><span class="o">.</span><span class="n">TrioBackend</span><span class="p">()</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">httpcore</span><span class="o">.</span><span class="n">AsyncConnectionPool</span><span class="p">(</span><span class="n">network_backend</span><span class="o">=</span><span class="n">network_backend</span><span class="p">)</span> <span class="k">as</span> <span class="n">http</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">http</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;https://www.example.com&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>

<span class="n">trio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
</code></pre></div>

<h3 id="mock-network-backends">Mock network backends</h3>
<p>There are also mock network backends available that can be useful for testing purposes.
These backends accept a list of bytes, and return network stream interfaces that return those byte streams.</p>
<p>Here's an example of mocking a simple HTTP/1.1 response...</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">httpcore</span>

<span class="n">network_backend</span> <span class="o">=</span> <span class="n">httpcore</span><span class="o">.</span><span class="n">MockBackend</span><span class="p">([</span>
    <span class="sa">b</span><span class="s2">&quot;HTTP/1.1 200 OK</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="sa">b</span><span class="s2">&quot;Content-Type: plain/text</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="sa">b</span><span class="s2">&quot;Content-Length: 13</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="sa">b</span><span class="s2">&quot;Hello, world!&quot;</span><span class="p">,</span>
<span class="p">])</span>
<span class="k">with</span> <span class="n">httpcore</span><span class="o">.</span><span class="n">ConnectionPool</span><span class="p">(</span><span class="n">network_backend</span><span class="o">=</span><span class="n">network_backend</span><span class="p">)</span> <span class="k">as</span> <span class="n">http</span><span class="p">:</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">http</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;https://example.com/&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">extensions</span><span class="p">[</span><span class="s1">&#39;http_version&#39;</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
</code></pre></div>

<p>Mocking a HTTP/2 response is more complex, since it uses a binary format...</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">hpack</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">hyperframe.frame</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">httpcore</span>

<span class="n">content</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">hyperframe</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">SettingsFrame</span><span class="p">()</span><span class="o">.</span><span class="n">serialize</span><span class="p">(),</span>
    <span class="n">hyperframe</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">HeadersFrame</span><span class="p">(</span>
        <span class="n">stream_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">data</span><span class="o">=</span><span class="n">hpack</span><span class="o">.</span><span class="n">Encoder</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="p">(</span><span class="sa">b</span><span class="s2">&quot;:status&quot;</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;200&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="sa">b</span><span class="s2">&quot;content-type&quot;</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;plain/text&quot;</span><span class="p">),</span>
            <span class="p">]</span>
        <span class="p">),</span>
        <span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;END_HEADERS&quot;</span><span class="p">],</span>
    <span class="p">)</span><span class="o">.</span><span class="n">serialize</span><span class="p">(),</span>
    <span class="n">hyperframe</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
        <span class="n">stream_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="sa">b</span><span class="s2">&quot;Hello, world!&quot;</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;END_STREAM&quot;</span><span class="p">]</span>
    <span class="p">)</span><span class="o">.</span><span class="n">serialize</span><span class="p">(),</span>
<span class="p">]</span>
<span class="c1"># Note that we instantiate the mock backend with an `http2=True` argument.</span>
<span class="c1"># This ensures that the mock network stream acts as if the `h2` ALPN flag has been set,</span>
<span class="c1"># and causes the connection pool to interact with the connection using HTTP/2.</span>
<span class="n">network_backend</span> <span class="o">=</span> <span class="n">httpcore</span><span class="o">.</span><span class="n">MockBackend</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">http2</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">with</span> <span class="n">httpcore</span><span class="o">.</span><span class="n">ConnectionPool</span><span class="p">(</span><span class="n">network_backend</span><span class="o">=</span><span class="n">network_backend</span><span class="p">)</span> <span class="k">as</span> <span class="n">http</span><span class="p">:</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">http</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;https://example.com/&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">extensions</span><span class="p">[</span><span class="s1">&#39;http_version&#39;</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
</code></pre></div>

<h3 id="custom-network-backends">Custom network backends</h3>
<p>The base interface for network backends is provided as public API, allowing you to implement custom networking behavior.</p>
<p>You can use this to provide advanced networking functionality such as:</p>
<ul>
<li>Network recording / replay.</li>
<li>In-depth debug tooling.</li>
<li>Handling non-standard SSL or DNS requirements.</li>
</ul>
<p>Here's an example that records the network response to a file on disk:</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">httpcore</span>


<span class="k">class</span><span class="w"> </span><span class="nc">RecordingNetworkStream</span><span class="p">(</span><span class="n">httpcore</span><span class="o">.</span><span class="n">NetworkStream</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record_file</span><span class="p">,</span> <span class="n">stream</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">record_file</span> <span class="o">=</span> <span class="n">record_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stream</span> <span class="o">=</span> <span class="n">stream</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_bytes</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">max_bytes</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">record_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">start_tls</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">ssl_context</span><span class="p">,</span>
        <span class="n">server_hostname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stream</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">start_tls</span><span class="p">(</span>
            <span class="n">ssl_context</span><span class="p">,</span> <span class="n">server_hostname</span><span class="o">=</span><span class="n">server_hostname</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_extra_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">info</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">get_extra_info</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">RecordingNetworkBackend</span><span class="p">(</span><span class="n">httpcore</span><span class="o">.</span><span class="n">NetworkBackend</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A custom network backend that records network responses.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record_file</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">record_file</span> <span class="o">=</span> <span class="n">record_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backend</span> <span class="o">=</span> <span class="n">httpcore</span><span class="o">.</span><span class="n">SyncBackend</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">connect_tcp</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">host</span><span class="p">,</span>
        <span class="n">port</span><span class="p">,</span>
        <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">local_address</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">socket_options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="c1"># Note that we&#39;re only using a single record file here,</span>
        <span class="c1"># so even if multiple connections are opened the network</span>
        <span class="c1"># traffic will all write to the same file.</span>

        <span class="c1"># An alternative implementation might automatically use</span>
        <span class="c1"># a new file for each opened connection.</span>
        <span class="n">stream</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">connect_tcp</span><span class="p">(</span>
            <span class="n">host</span><span class="p">,</span>
            <span class="n">port</span><span class="p">,</span>
            <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
            <span class="n">local_address</span><span class="o">=</span><span class="n">local_address</span><span class="p">,</span>
            <span class="n">socket_options</span><span class="o">=</span><span class="n">socket_options</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">RecordingNetworkStream</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">record_file</span><span class="p">,</span> <span class="n">stream</span><span class="p">)</span>


<span class="c1"># Once you make the request, the raw HTTP/1.1 response will be available</span>
<span class="c1"># in the &#39;network-recording&#39; file.</span>
<span class="c1">#</span>
<span class="c1"># Try switching to `http2=True` to see the difference when recording HTTP/2 binary network traffic,</span>
<span class="c1"># or add `headers={&#39;Accept-Encoding&#39;: &#39;gzip&#39;}` to see HTTP content compression.</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;network-recording&quot;</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">record_file</span><span class="p">:</span>
    <span class="n">network_backend</span> <span class="o">=</span> <span class="n">RecordingNetworkBackend</span><span class="p">(</span><span class="n">record_file</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">httpcore</span><span class="o">.</span><span class="n">ConnectionPool</span><span class="p">(</span><span class="n">network_backend</span><span class="o">=</span><span class="n">network_backend</span><span class="p">)</span> <span class="k">as</span> <span class="n">http</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">http</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;https://www.example.com/&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</code></pre></div>

<hr />
<h2 id="reference">Reference</h2>
<h3 id="networking-backends">Networking Backends</h3>
<ul>
<li><code>httpcore.SyncBackend</code></li>
<li><code>httpcore.AnyIOBackend</code></li>
<li><code>httpcore.TrioBackend</code></li>
</ul>
<h3 id="mock-backends">Mock Backends</h3>
<ul>
<li><code>httpcore.MockBackend</code></li>
<li><code>httpcore.MockStream</code></li>
<li><code>httpcore.AsyncMockBackend</code></li>
<li><code>httpcore.AsyncMockStream</code></li>
</ul>
<h3 id="base-interface">Base Interface</h3>
<ul>
<li><code>httpcore.NetworkBackend</code></li>
<li><code>httpcore.NetworkStream</code></li>
<li><code>httpcore.AsyncNetworkBackend</code></li>
<li><code>httpcore.AsyncNetworkStream</code></li>
</ul>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.ad660dcc.min.js"></script>
      
    
  </body>
</html>