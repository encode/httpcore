
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="A minimal HTTP client for Python.">
      
      
      
        <link rel="canonical" href="https://www.encode.io/httpcore/http2/">
      
      
        <link rel="prev" href="../proxies/">
      
      
        <link rel="next" href="../async/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.0, mkdocs-material-9.5.27">
    
    
      
        <title>HTTP/2 - HTTPCore</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.6543a935.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#http2" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="HTTPCore" class="md-header__button md-logo" aria-label="HTTPCore" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            HTTPCore
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              HTTP/2
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/encode/httpcore/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    encode/httpcore
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="HTTPCore" class="md-nav__button md-logo" aria-label="HTTPCore" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    HTTPCore
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/encode/httpcore/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    encode/httpcore
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Introduction
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../quickstart/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Quickstart
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../connection-pools/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Connection Pools
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../proxies/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Proxies
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    HTTP/2
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    HTTP/2
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#enabling-http2" class="md-nav__link">
    <span class="md-ellipsis">
      Enabling HTTP/2
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#inspecting-the-http-version" class="md-nav__link">
    <span class="md-ellipsis">
      Inspecting the HTTP version
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#http2-negotiation" class="md-nav__link">
    <span class="md-ellipsis">
      HTTP/2 negotiation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="HTTP/2 negotiation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#http2-over-https" class="md-nav__link">
    <span class="md-ellipsis">
      HTTP/2 over HTTPS
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#http2-over-http" class="md-nav__link">
    <span class="md-ellipsis">
      HTTP/2 over HTTP
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prior-knowledge" class="md-nav__link">
    <span class="md-ellipsis">
      Prior Knowledge
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#request-response-headers" class="md-nav__link">
    <span class="md-ellipsis">
      Request &amp; response headers
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#request-headers" class="md-nav__link">
    <span class="md-ellipsis">
      Request headers
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#response-headers" class="md-nav__link">
    <span class="md-ellipsis">
      Response headers
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../async/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Async Support
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../network-backends/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Network Backends
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../extensions/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Extensions
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../logging/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Logging
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../exceptions/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Exceptions
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#enabling-http2" class="md-nav__link">
    <span class="md-ellipsis">
      Enabling HTTP/2
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#inspecting-the-http-version" class="md-nav__link">
    <span class="md-ellipsis">
      Inspecting the HTTP version
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#http2-negotiation" class="md-nav__link">
    <span class="md-ellipsis">
      HTTP/2 negotiation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="HTTP/2 negotiation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#http2-over-https" class="md-nav__link">
    <span class="md-ellipsis">
      HTTP/2 over HTTPS
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#http2-over-http" class="md-nav__link">
    <span class="md-ellipsis">
      HTTP/2 over HTTP
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prior-knowledge" class="md-nav__link">
    <span class="md-ellipsis">
      Prior Knowledge
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#request-response-headers" class="md-nav__link">
    <span class="md-ellipsis">
      Request &amp; response headers
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#request-headers" class="md-nav__link">
    <span class="md-ellipsis">
      Request headers
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#response-headers" class="md-nav__link">
    <span class="md-ellipsis">
      Response headers
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="http2">HTTP/2</h1>
<p>HTTP/2 is a major new iteration of the HTTP protocol, that provides a more efficient transport, with potential performance benefits. HTTP/2 does not change the core semantics of the request or response, but alters the way that data is sent to and from the server.</p>
<p>Rather than the text format that HTTP/1.1 uses, HTTP/2 is a binary format. The binary format provides full request and response multiplexing, and efficient compression of HTTP headers. The stream multiplexing means that where HTTP/1.1 requires one TCP stream for each concurrent request, HTTP/2 allows a single TCP stream to handle multiple concurrent requests.</p>
<p>HTTP/2 also provides support for functionality such as response prioritization, and server push.</p>
<p>For a comprehensive guide to HTTP/2 you may want to check out "<a href="https://http2-explained.haxx.se">HTTP2 Explained</a>".</p>
<h2 id="enabling-http2">Enabling HTTP/2</h2>
<p>When using the <code>httpcore</code> client, HTTP/2 support is not enabled by default, because HTTP/1.1 is a mature, battle-hardened transport layer, and our HTTP/1.1 implementation may be considered the more robust option at this point in time. It is possible that a future version of <code>httpcore</code> may enable HTTP/2 support by default.</p>
<p>If you're issuing highly concurrent requests you might want to consider trying out our HTTP/2 support. You can do so by first making sure to install the optional HTTP/2 dependencies...</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span><span class="s1">&#39;httpcore[http2]&#39;</span>
</code></pre></div>

<p>And then instantiating a connection pool with HTTP/2 support enabled:</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">httpcore</span>

<span class="n">pool</span> <span class="o">=</span> <span class="n">httpcore</span><span class="o">.</span><span class="n">ConnectionPool</span><span class="p">(</span><span class="n">http2</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>

<p>We can take a look at the difference in behaviour by issuing several outgoing requests in parallel.</p>
<p>Start out by using a standard HTTP/1.1 connection pool:</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">httpcore</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">concurrent.futures</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>


<span class="k">def</span><span class="w"> </span><span class="nf">download</span><span class="p">(</span><span class="n">http</span><span class="p">,</span> <span class="n">year</span><span class="p">):</span>
    <span class="n">http</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;https://en.wikipedia.org/wiki/</span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">httpcore</span><span class="o">.</span><span class="n">ConnectionPool</span><span class="p">()</span> <span class="k">as</span> <span class="n">http</span><span class="p">:</span>
        <span class="n">started</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span> <span class="k">as</span> <span class="n">threads</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">2020</span><span class="p">):</span>
                <span class="n">threads</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">download</span><span class="p">,</span> <span class="n">http</span><span class="p">,</span> <span class="n">year</span><span class="p">)</span>
        <span class="n">complete</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">connection</span> <span class="ow">in</span> <span class="n">http</span><span class="o">.</span><span class="n">connections</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Complete in </span><span class="si">%.3f</span><span class="s2"> seconds&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">complete</span> <span class="o">-</span> <span class="n">started</span><span class="p">))</span>


<span class="n">main</span><span class="p">()</span>
</code></pre></div>

<p>If you run this with an HTTP/1.1 connection pool, you ought to see output similar to the following:</p>
<div class="highlight"><pre><span></span><code><span class="o">&lt;</span><span class="n">HTTPConnection</span> <span class="p">[</span><span class="s1">&#39;https://en.wikipedia.org:443&#39;</span><span class="p">,</span> <span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span><span class="p">,</span> <span class="n">IDLE</span><span class="p">,</span> <span class="n">Request</span> <span class="n">Count</span><span class="p">:</span> <span class="mi">2</span><span class="p">]</span><span class="o">&gt;</span><span class="p">,</span>
<span class="o">&lt;</span><span class="n">HTTPConnection</span> <span class="p">[</span><span class="s1">&#39;https://en.wikipedia.org:443&#39;</span><span class="p">,</span> <span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span><span class="p">,</span> <span class="n">IDLE</span><span class="p">,</span> <span class="n">Request</span> <span class="n">Count</span><span class="p">:</span> <span class="mi">3</span><span class="p">]</span><span class="o">&gt;</span><span class="p">,</span>
<span class="o">&lt;</span><span class="n">HTTPConnection</span> <span class="p">[</span><span class="s1">&#39;https://en.wikipedia.org:443&#39;</span><span class="p">,</span> <span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span><span class="p">,</span> <span class="n">IDLE</span><span class="p">,</span> <span class="n">Request</span> <span class="n">Count</span><span class="p">:</span> <span class="mi">6</span><span class="p">]</span><span class="o">&gt;</span><span class="p">,</span>
<span class="o">&lt;</span><span class="n">HTTPConnection</span> <span class="p">[</span><span class="s1">&#39;https://en.wikipedia.org:443&#39;</span><span class="p">,</span> <span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span><span class="p">,</span> <span class="n">IDLE</span><span class="p">,</span> <span class="n">Request</span> <span class="n">Count</span><span class="p">:</span> <span class="mi">5</span><span class="p">]</span><span class="o">&gt;</span><span class="p">,</span>
<span class="o">&lt;</span><span class="n">HTTPConnection</span> <span class="p">[</span><span class="s1">&#39;https://en.wikipedia.org:443&#39;</span><span class="p">,</span> <span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span><span class="p">,</span> <span class="n">IDLE</span><span class="p">,</span> <span class="n">Request</span> <span class="n">Count</span><span class="p">:</span> <span class="mi">1</span><span class="p">]</span><span class="o">&gt;</span><span class="p">,</span>
<span class="o">&lt;</span><span class="n">HTTPConnection</span> <span class="p">[</span><span class="s1">&#39;https://en.wikipedia.org:443&#39;</span><span class="p">,</span> <span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span><span class="p">,</span> <span class="n">IDLE</span><span class="p">,</span> <span class="n">Request</span> <span class="n">Count</span><span class="p">:</span> <span class="mi">1</span><span class="p">]</span><span class="o">&gt;</span><span class="p">,</span>
<span class="o">&lt;</span><span class="n">HTTPConnection</span> <span class="p">[</span><span class="s1">&#39;https://en.wikipedia.org:443&#39;</span><span class="p">,</span> <span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span><span class="p">,</span> <span class="n">IDLE</span><span class="p">,</span> <span class="n">Request</span> <span class="n">Count</span><span class="p">:</span> <span class="mi">1</span><span class="p">]</span><span class="o">&gt;</span><span class="p">,</span>
<span class="o">&lt;</span><span class="n">HTTPConnection</span> <span class="p">[</span><span class="s1">&#39;https://en.wikipedia.org:443&#39;</span><span class="p">,</span> <span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span><span class="p">,</span> <span class="n">IDLE</span><span class="p">,</span> <span class="n">Request</span> <span class="n">Count</span><span class="p">:</span> <span class="mi">1</span><span class="p">]</span><span class="o">&gt;</span>
<span class="n">Complete</span> <span class="ow">in</span> <span class="mf">0.586</span> <span class="n">seconds</span>
</code></pre></div>

<p>We can see that the connection pool required a number of connections in order to handle the parallel requests.</p>
<p>If we now upgrade our connection pool to support HTTP/2:</p>
<div class="highlight"><pre><span></span><code><span class="k">with</span> <span class="n">httpcore</span><span class="o">.</span><span class="n">ConnectionPool</span><span class="p">(</span><span class="n">http2</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">http</span><span class="p">:</span>
    <span class="o">...</span>
</code></pre></div>

<p>And run the same script again, we should end up with something like this:</p>
<div class="highlight"><pre><span></span><code><span class="o">&lt;</span><span class="n">HTTPConnection</span> <span class="p">[</span><span class="s1">&#39;https://en.wikipedia.org:443&#39;</span><span class="p">,</span> <span class="n">HTTP</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">IDLE</span><span class="p">,</span> <span class="n">Request</span> <span class="n">Count</span><span class="p">:</span> <span class="mi">20</span><span class="p">]</span><span class="o">&gt;</span>
<span class="n">Complete</span> <span class="ow">in</span> <span class="mf">0.573</span> <span class="n">seconds</span>
</code></pre></div>

<p>All of our requests have been handled over a single connection.</p>
<p>Switching to HTTP/2 should not <em>necessarily</em> be considered an "upgrade". It is more complex, and requires more computational power, and so particularly in an interpreted language like Python it <em>could</em> be slower in some instances. Moreover, utilising multiple connections may end up connecting to multiple hosts, and could sometimes appear faster to the client, at the cost of requiring more server resources. Enabling HTTP/2 is most likely to be beneficial if you are sending requests in high concurrency, and may often be more well suited to an async context, rather than multi-threading.</p>
<h2 id="inspecting-the-http-version">Inspecting the HTTP version</h2>
<p>Enabling HTTP/2 support on the client does not <em>necessarily</em> mean that your requests and responses will be transported over HTTP/2, since both the client <em>and</em> the server need to support HTTP/2. If you connect to a server that only supports HTTP/1.1 the client will use a standard HTTP/1.1 connection instead.</p>
<p>You can determine which version of the HTTP protocol was used by examining the <code>"http_version"</code> response extension.</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">httpcore</span>

<span class="n">pool</span> <span class="o">=</span> <span class="n">httpcore</span><span class="o">.</span><span class="n">ConnectionPool</span><span class="p">(</span><span class="n">http2</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">response</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;https://www.example.com/&quot;</span><span class="p">)</span>

<span class="c1"># Should be one of b&quot;HTTP/2&quot;, b&quot;HTTP/1.1&quot;, b&quot;HTTP/1.0&quot;, or b&quot;HTTP/0.9&quot;.</span>
<span class="nb">print</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">extensions</span><span class="p">[</span><span class="s2">&quot;http_version&quot;</span><span class="p">])</span>
</code></pre></div>

<p>See <a href="../extensions/">the extensions documentation</a> for more details.</p>
<h2 id="http2-negotiation">HTTP/2 negotiation</h2>
<p>Robust servers need to support both HTTP/2 and HTTP/1.1 capable clients, and so need some way to "negotiate" with the client which protocol version will be used.</p>
<h3 id="http2-over-https">HTTP/2 over HTTPS</h3>
<p>Generally the method used is for the server to advertise if it has HTTP/2 support during the part of the SSL connection handshake. This is known as ALPN - "Application Layer Protocol Negotiation".</p>
<p>Most browsers only provide HTTP/2 support over HTTPS connections, and this is also the default behaviour that <code>httpcore</code> provides. If you enable HTTP/2 support you should still expect to see HTTP/1.1 connections for any <code>http://</code> URLs.</p>
<h3 id="http2-over-http">HTTP/2 over HTTP</h3>
<p>Servers can optionally also support HTTP/2 over HTTP by supporting the <code>Upgrade: h2c</code> header.</p>
<p>This mechanism is not supported by <code>httpcore</code>. It requires an additional round-trip between the client and server, and also requires any request body to be sent twice.</p>
<h3 id="prior-knowledge">Prior Knowledge</h3>
<p>If you know in advance that the server you are communicating with will support HTTP/2, then you can enforce that the client uses HTTP/2, without requiring either ALPN support or an HTTP <code>Upgrade: h2c</code> header.</p>
<p>This is managed by disabling HTTP/1.1 support on the connection pool:</p>
<div class="highlight"><pre><span></span><code><span class="n">pool</span> <span class="o">=</span> <span class="n">httpcore</span><span class="o">.</span><span class="n">ConnectionPool</span><span class="p">(</span><span class="n">http1</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">http2</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>

<h2 id="request-response-headers">Request &amp; response headers</h2>
<p>Because HTTP/2 frames the requests and responses somewhat differently to HTTP/1.1, there is a difference in some of the headers that are used.</p>
<p>In order for the <code>httpcore</code> library to support both HTTP/1.1 and HTTP/2 transparently, the HTTP/1.1 style is always used throughout the API. Any differences in header styles are only mapped onto HTTP/2 at the internal network layer.</p>
<h2 id="request-headers">Request headers</h2>
<p>The following pseudo-headers are used by HTTP/2 in the request:</p>
<ul>
<li><code>:method</code> - The request method.</li>
<li><code>:path</code> - Taken from the URL of the request.</li>
<li><code>:authority</code> - Equivalent to the <code>Host</code> header in HTTP/1.1. In <code>httpcore</code> this is represented using the request <code>Host</code> header, which is automatically populated from the request URL if no <code>Host</code> header is explicitly included.</li>
<li><code>:scheme</code> - Taken from the URL of the request.</li>
</ul>
<p>These pseudo-headers are included in <code>httpcore</code> as part of the <code>request.method</code> and <code>request.url</code> attributes, and through the <code>request.headers["Host"]</code> header. <em>They are not exposed directly by their psuedo-header names.</em></p>
<p>The one other difference to be aware of is the <code>Transfer-Encoding: chunked</code> header.</p>
<p>In HTTP/2 this header is never used, since streaming data is framed using a different mechanism.</p>
<p>In <code>httpcore</code> the <code>Transfer-Encoding: chunked</code> header is always used to represent the presence of a streaming body on the request, and is automatically populated if required. However the header is only sent if the underlying connection ends up being HTTP/1.1, and is omitted if the underlying connection ends up being HTTP/2.</p>
<h2 id="response-headers">Response headers</h2>
<p>The following pseudo-header is used by HTTP/2 in the response:</p>
<ul>
<li><code>:status</code> - The response status code.</li>
</ul>
<p>In <code>httpcore</code> this <em>is represented by the <code>response.status</code> attribute, rather than being exposed as a psuedo-header</em>.</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.ad660dcc.min.js"></script>
      
    
  </body>
</html>